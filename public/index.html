<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Audit Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .api-config {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .env-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .env-toggle {
            display: flex;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 2px;
            gap: 2px;
        }

        .env-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 18px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: transparent;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .env-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .env-btn:hover:not(.active) {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.9);
        }

        .env-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }

        .env-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .env-status.dev {
            background: #4CAF50;
        }

        .env-status.prod {
            background: #FF5722;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .endpoint-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .endpoint-label {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
            min-width: 100px;
        }

        .endpoint-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            min-width: 300px;
        }

        .manual-toggle {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            padding: 4px 8px;
            color: rgba(255,255,255,0.8);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .manual-toggle:hover {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .manual-toggle.active {
            background: #FF9800;
            color: white;
            border-color: #FF9800;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            min-width: 300px;
        }

        .input-group input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        .input-group input:disabled {
            background-color: #f5f5f5;
            color: #666;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #1976D2;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }

        .success {
            background: #4CAF50;
            color: white;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
            border-bottom-color: #4f5fd8;
        }

        .tab-btn:hover:not(.active) {
            background: #f0f0f0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
            color: #333;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            background: #667eea;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .table-filters select,
        .table-filters input {
            padding: 8px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
        }

        .status-unavailable {
            background: #f8d7da;
            color: #721c24;
        }

        .status-valid {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-invalid {
            background: #f5c6cb;
            color: #721c24;
        }

        .status-unknown {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-wrong-path {
            background: #f5c6cb;
            color: #721c24;
        }

        .status-external {
            background: #d1ecf1;
            color: #0c5460;
        }

        .url-link {
            color: #667eea;
            text-decoration: none;
            word-break: break-all;
        }

        .url-link:hover {
            text-decoration: underline;
        }

        .export-section {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .category-badge {
            background: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .env-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .endpoint-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .endpoint-input-group {
                width: 100%;
                min-width: auto;
            }

            .input-group {
                flex-direction: column;
            }

            .input-group input {
                min-width: auto;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .tabs {
                flex-direction: column;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        .sub-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .sub-tab-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-radius: 6px;
            color: #666;
        }

        .sub-tab-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .sub-tab-btn:hover:not(.active) {
            background: #e9ecef;
            color: #333;
        }

        .sub-tab-content {
            display: block;
        }

        .sub-tab-content.hidden {
            display: none;
        }

        .hidden {
            display: none;
        }

        .insight-item {
            margin-bottom: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .insight-header {
            padding: 1rem;
            border-bottom: 1px solid;
        }

        .insight-content {
            padding: 1rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .insight-link-item {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
            border-left: 2px solid;
            transition: background-color 0.2s ease;
        }

        .insight-link-item:hover {
            background: rgba(255,255,255,0.9);
        }

        .link-text {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.2rem;
        }

        .link-url {
            font-size: 12px;
            color: #666;
            font-family: monospace;
            word-break: break-all;
            margin-bottom: 0.2rem;
        }

        .link-error {
            font-size: 12px;
            color: #d32f2f;
            font-style: italic;
        }

        .category-tag {
            font-size: 11px;
            background: #e0e0e0;
            padding: 1px 4px;
            border-radius: 2px;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <h1>üîç Link Audit Dashboard</h1>
            
            <div class="api-config">
                <!-- Environment Controls -->
                <div class="env-controls">
                    <div class="env-toggle">
                        <button class="env-btn" id="devBtn" data-env="dev">üîß Development</button>
                        <button class="env-btn" id="prodBtn" data-env="prod">üöÄ Production</button>
                    </div>
                    
                    <div class="env-indicator">
                        <div class="env-status" id="envStatus"></div>
                        <span id="envText">Detecting environment...</span>
                    </div>
                </div>

                <!-- API Endpoint Controls -->
                <div class="endpoint-controls">
                    <div class="endpoint-label">API Endpoint:</div>
                    <div class="endpoint-input-group">
                        <input type="text" id="apiEndpoint" placeholder="API Endpoint URL">
                        <button class="manual-toggle" id="manualToggle" title="Enable manual endpoint editing">
                            ‚úèÔ∏è Manual
                        </button>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <input type="url" id="urlInput" placeholder="Enter URL to audit (e.g., https://www.adventure-life.com/galapagos)" value="https://www.adventure-life.com/galapagos">
                <button class="btn btn-primary" id="analyzeBtn">üöÄ Analyze Links</button>
                <button class="btn btn-secondary" id="clearBtn">üóëÔ∏è Clear Results</button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading hidden">
            <div class="spinner"></div>
            <h3>Analyzing links...</h3>
            <p>This may take a few moments depending on the number of links found.</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error hidden"></div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            
            <!-- Navigation Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="summary">üìä Summary</button>
                <button class="tab-btn" data-tab="charts">üìà Charts</button>
                <button class="tab-btn" data-tab="details">üìã Details</button>
                <button class="tab-btn" data-tab="export">üíæ Export</button>
            </div>

            <!-- Summary Tab -->
            <div id="summaryTab" class="tab-content active">
                <div class="stats-grid" id="statsGrid">
                    <!-- Stats will be populated here -->
                </div>
                
                <!-- Quick Insights Panel -->
                <div class="table-container" id="insightsPanel" style="display: none;">
                    <div class="table-header">
                        <h3>üö® Detailed Issues & Errors Found</h3>
                        <small style="color: rgba(255,255,255,0.8);">All problematic links with specific error details</small>
                    </div>
                    <div style="padding: 1rem;">
                        <div id="insightsContent">
                            <!-- Insights will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Tab -->
            <div id="chartsTab" class="tab-content">
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">Links by Category</h3>
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Availability Status</h3>
                        <canvas id="availabilityChart"></canvas>
                    </div>
                </div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">Validation Results</h3>
                        <canvas id="validationChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Link Sources</h3>
                        <canvas id="sourceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Details Tab -->
            <div id="detailsTab" class="tab-content">
                <!-- Sub-tabs for different views -->
                <div class="sub-tabs" style="margin-bottom: 1rem;">
                    <button class="sub-tab-btn active" data-subtab="section">üìç By Section</button>
                    <button class="sub-tab-btn" data-subtab="urlpattern">üîó By URL Pattern</button>
                </div>

                <!-- Sub-tab contents -->
                <div id="sectionView" class="sub-tab-content active">
                    <!-- Section-based tables will be populated here -->
                </div>

                <div id="urlpatternView" class="sub-tab-content hidden">
                    <!-- URL pattern-based tables will be populated here -->
                </div>
            </div>

            <!-- Export Tab -->
            <div id="exportTab" class="tab-content">
                <div class="export-section">
                    <h3>üì• Export Data</h3>
                    <p>Download your analysis results in various formats:</p>
                    <div class="export-buttons">
                        <button class="btn btn-primary" id="exportJsonBtn">üìÑ Export JSON</button>
                        <button class="btn btn-primary" id="exportCsvBtn">üìä Export CSV</button>
                        <button class="btn btn-secondary" id="printReportBtn">üñ®Ô∏è Print Report</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class LinkAuditDashboard {
            constructor() {
                this.data = null;
                this.charts = {};
                this.auditUrl = '';
                this.currentEnvironment = 'dev';
                this.isManualMode = false;
                
                // API endpoints configuration
                this.endpoints = {
                    dev: 'http://localhost:3000/api/v1/audit-script',
                    prod: 'https://al-audit.onrender.com/api/v1/audit-script'
                };
                
                this.initializeEnvironment();
                this.initializeEventListeners();
            }

            initializeEnvironment() {
                // Auto-detect environment based on hostname
                const hostname = window.location.hostname;
                const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1' || hostname.startsWith('192.168.') || hostname.startsWith('10.') || hostname.startsWith('172.');
                
                this.currentEnvironment = isLocalhost ? 'dev' : 'prod';
                
                // Update UI
                this.updateEnvironmentUI();
                this.updateApiEndpoint();
                
                console.log(`üåç Environment detected: ${this.currentEnvironment.toUpperCase()}`);
                console.log(`üîó API Endpoint: ${this.endpoints[this.currentEnvironment]}`);
            }

            updateEnvironmentUI() {
                const envStatus = document.getElementById('envStatus');
                const envText = document.getElementById('envText');
                const devBtn = document.getElementById('devBtn');
                const prodBtn = document.getElementById('prodBtn');
                
                // Update status indicator
                envStatus.className = `env-status ${this.currentEnvironment}`;
                envText.textContent = this.currentEnvironment === 'dev' ? 
                    'Development Environment' : 'Production Environment';
                
                // Update toggle buttons
                devBtn.classList.toggle('active', this.currentEnvironment === 'dev');
                prodBtn.classList.toggle('active', this.currentEnvironment === 'prod');
            }

            updateApiEndpoint() {
                if (!this.isManualMode) {
                    const apiEndpointInput = document.getElementById('apiEndpoint');
                    apiEndpointInput.value = this.endpoints[this.currentEnvironment];
                    apiEndpointInput.disabled = true;
                }
            }

            toggleManualMode() {
                this.isManualMode = !this.isManualMode;
                const apiEndpointInput = document.getElementById('apiEndpoint');
                const manualToggle = document.getElementById('manualToggle');
                
                if (this.isManualMode) {
                    apiEndpointInput.disabled = false;
                    manualToggle.classList.add('active');
                    manualToggle.innerHTML = 'üîí Manual';
                    manualToggle.title = 'Disable manual editing (use auto endpoints)';
                } else {
                    apiEndpointInput.disabled = true;
                    manualToggle.classList.remove('active');
                    manualToggle.innerHTML = '‚úèÔ∏è Manual';
                    manualToggle.title = 'Enable manual endpoint editing';
                    this.updateApiEndpoint();
                }
            }

            switchEnvironment(environment) {
                if (this.currentEnvironment === environment) return;
                
                this.currentEnvironment = environment;
                this.updateEnvironmentUI();
                
                if (!this.isManualMode) {
                    this.updateApiEndpoint();
                }
                
                console.log(`üîÑ Environment switched to: ${environment.toUpperCase()}`);
                console.log(`üîó API Endpoint: ${this.endpoints[environment]}`);
            }

            initializeEventListeners() {
                // Environment toggle buttons
                document.getElementById('devBtn').addEventListener('click', () => {
                    this.switchEnvironment('dev');
                });
                
                document.getElementById('prodBtn').addEventListener('click', () => {
                    this.switchEnvironment('prod');
                });
                
                // Manual toggle button
                document.getElementById('manualToggle').addEventListener('click', () => {
                    this.toggleManualMode();
                });

                // Tab navigation
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                });

                // Sub-tab navigation
                document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.switchSubTab(e.target.dataset.subtab));
                });

                // Main buttons
                document.getElementById('analyzeBtn').addEventListener('click', () => this.analyzeUrl());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearResults());
                
                // Export buttons
                document.getElementById('exportJsonBtn').addEventListener('click', () => this.exportJson());
                document.getElementById('exportCsvBtn').addEventListener('click', () => this.exportCsv());
                document.getElementById('printReportBtn').addEventListener('click', () => this.printReport());

                // Enter key on URL input
                document.getElementById('urlInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.analyzeUrl();
                });
            }

            // NEW: Extract destination from audit URL (last meaningful segment)
            extractDestinationFromUrl(url) {
                try {
                    const urlObj = new URL(url);
                    const pathSegments = urlObj.pathname
                        .split('/')
                        .filter(segment => segment.length > 0)
                        .filter(segment => !['tours', 'cruises', 'hotels', 'articles', 'stories', 'deals', 'info'].includes(segment.toLowerCase()));
                    
                    if (pathSegments.length === 0) return 'this destination';
                    
                    // Get the last meaningful segment and capitalize it
                    const lastSegment = pathSegments[pathSegments.length - 1];
                    return lastSegment.charAt(0).toUpperCase() + lastSegment.slice(1).replace(/-/g, ' ');
                } catch (error) {
                    return 'this destination';
                }
            }

            // NEW: Convert technical errors to user-friendly messages
            convertToUserFriendlyError(error, urlPattern, destination, linkText) {
                if (!error) return '';

                const errorLower = error.toLowerCase();
                
                // Handle HTTP status codes
                if (errorLower.includes('404') || errorLower.includes('not found')) {
                    return 'Page not found or no longer available';
                }
                
                if (errorLower.includes('500') || errorLower.includes('502') || errorLower.includes('503') || errorLower.includes('504')) {
                    return 'Website temporarily unavailable';
                }
                
                if (errorLower.includes('timeout') || errorLower.includes('took too long')) {
                    return 'Page took too long to load';
                }
                
                if (errorLower.includes('network') || errorLower.includes('connection') || errorLower.includes('connect')) {
                    return 'Unable to connect to this page';
                }
                
                if (errorLower.includes('no price') || errorLower.includes('price not found')) {
                    return 'Pricing information not available';
                }
                
                if (errorLower.includes('validation failed') || errorLower.includes('cannot be accessed')) {
                    return 'Page cannot be accessed';
                }
                
                if (errorLower.includes('redirect')) {
                    return 'Page has moved to a different location';
                }

                if (errorLower.includes('wrong path') || errorLower.includes('contactt')) {
                    return 'Incorrect website address - may have typing error';
                }

                // Return original error if no pattern matches, but make it more user-friendly
                return error.charAt(0).toUpperCase() + error.slice(1);
            }

            // NEW: Get unavailable message based on URL pattern
            getUnavailableMessage(urlPattern, destination, linkText) {
                switch (urlPattern) {
                    case 'cruise-ship':
                        return `This cruise ship is no longer available for ${destination} tours`;
                    
                    case 'tour-with-id':
                        return `This tour is currently unavailable in ${destination}`;
                    
                    case 'tour-activity':
                        return `This activity is not offered in ${destination} anymore`;
                    
                    case 'cruise-with-id':
                        return `This cruise is no longer available in ${destination}`;
                    
                    case 'destination-special-page':
                        return `This ${destination} page is currently unavailable`;
                    
                    case 'multi-level/stories/story-name':
                    case 'multi-level/articles/article-name':
                        return 'This content is no longer available';
                    
                    case 'contact-page':
                        return 'Contact page is currently unavailable';
                    
                    case 'wrong-contact-path':
                        return 'Incorrect contact page address - may have typing error';
                    
                    case 'external-link':
                        return 'External website is currently unavailable';
                    
                    default:
                        if (urlPattern && urlPattern.startsWith('multi-level/destination-')) {
                            return `This ${destination} page is currently unavailable`;
                        }
                        return 'This page is currently unavailable';
                }
            }

            // NEW: Get user-friendly reason for link status
            getUserFriendlyReason(link, destination) {
                let reasonText = '';
                
                // Handle available/unavailable status
                if (link.available !== undefined) {
                    if (link.available) {
                        // Available - show positive reasons
                        if (link.price) {
                            reasonText = `Available - Pricing: ${link.price} ${link.currency || ''}`;
                        } else if (link.shipOptions && link.shipOptions.length > 0) {
                            reasonText = `Available - ${link.shipOptions.length} cruise ships available`;
                        } else if (link.experienceOptions && link.experienceOptions.length > 0) {
                            reasonText = `Available - ${link.experienceOptions.length} experiences available`;
                        } else if (link.pageType === 'landing') {
                            reasonText = 'Available - Direct activity page accessible';
                        } else {
                            reasonText = 'Available - Page accessible and content found';
                        }
                    } else {
                        // Unavailable - use pattern-specific messages
                        const unavailableMsg = this.getUnavailableMessage(link.category, destination, link.text);
                        
                        // Add specific error if available
                        if (link.availabilityError || link.error) {
                            const specificError = this.convertToUserFriendlyError(
                                link.availabilityError || link.error, 
                                link.category, 
                                destination, 
                                link.text
                            );
                            reasonText = `${unavailableMsg} - ${specificError}`;
                        } else {
                            reasonText = unavailableMsg;
                        }
                    }
                } 
                // Handle valid/invalid status for non-availability checks
                else if (link.valid !== undefined) {
                    if (link.valid) {
                        reasonText = link.status ? 
                            `Page accessible - Status: ${link.status}` : 
                            'Page accessible and working correctly';
                    } else {
                        // Invalid - get user-friendly error
                        if (link.validationError) {
                            reasonText = this.convertToUserFriendlyError(
                                link.validationError, 
                                link.category, 
                                destination, 
                                link.text
                            );
                        } else if (link.status) {
                            reasonText = this.convertToUserFriendlyError(
                                `HTTP ${link.status}`, 
                                link.category, 
                                destination, 
                                link.text
                            );
                        } else {
                            reasonText = 'Page cannot be accessed';
                        }
                    }
                } else {
                    reasonText = 'Not tested or data unavailable';
                }
                
                return reasonText;
            }

            switchSubTab(subTabName) {
                // Update sub-tab buttons
                document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-subtab="${subTabName}"]`).classList.add('active');

                // Update sub-tab content
                document.querySelectorAll('.sub-tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`${subTabName}View`).classList.remove('hidden');

                // Render the appropriate view if data exists
                if (this.data) {
                    this.renderDetailView(subTabName);
                }
            }

            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabName}Tab`).classList.add('active');
            }

            async analyzeUrl() {
                const url = document.getElementById('urlInput').value.trim();
                const apiEndpoint = document.getElementById('apiEndpoint').value.trim();

                if (!url) {
                    this.showError('Please enter a URL to analyze');
                    return;
                }

                if (!apiEndpoint) {
                    this.showError('Please enter an API endpoint');
                    return;
                }

                // Store audit URL for destination extraction
                this.auditUrl = url;

                this.showLoading(true);
                this.clearError();

                try {
                    console.log(`üîÑ Making request to: ${apiEndpoint}`);
                    console.log(`üåç Current environment: ${this.currentEnvironment.toUpperCase()}`);
                    
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ url })
                    });

                    // Debug the response structure step by step
                    console.log('üîç 1. RESPONSE OBJECT:', response);
                    console.log('üîç 2. RESPONSE STATUS:', response.status);
                    console.log('üîç 3. RESPONSE OK:', response.ok);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    // Get the actual response data
                    const responseData = await response.json();
                    
                    // Debug the actual data
                    console.log('üîç 4. RESPONSE DATA TYPE:', typeof responseData);
                    console.log('üîç 5. RESPONSE DATA KEYS:', Object.keys(responseData || {}));
                    console.log('üîç 6. RAW API RESPONSE:', JSON.stringify(responseData, null, 2));

                    // Check specific parts
                    if (responseData) {
                        console.log('üîç 7. DETAILED RESULTS KEYS:', Object.keys(responseData.detailedResults || {}));
                        console.log('üîç 8. STATS:', responseData.stats);
                        
                        // Look for the tour specifically
                        if (responseData.detailedResults) {
                            Object.keys(responseData.detailedResults).forEach(category => {
                                const links = responseData.detailedResults[category];
                                if (Array.isArray(links)) {
                                    const classicPeru = links.find(link => 
                                        link.text && link.text.toLowerCase().includes('classic peru')
                                    );
                                    if (classicPeru) {
                                        console.log('üéØ FOUND CLASSIC PERU TOUR:', JSON.stringify(classicPeru, null, 2));
                                    }
                                }
                            });
                        }
                    }

                    this.data = responseData;  // Changed from response.data to responseData
                    this.showResults();
                    this.showSuccess('Analysis completed successfully!');

                } catch (error) {
                    console.error('‚ùå API ERROR:', error);
                    console.log('üîç ERROR DETAILS:', {
                        message: error.message,
                        stack: error.stack
                    });
                    
                    // Enhanced error message with environment context
                    let errorMessage = `Analysis failed: ${error.message}`;
                    if (error.message.includes('Failed to fetch') || error.message.includes('Network')) {
                        errorMessage += `\n\nüåç Current environment: ${this.currentEnvironment.toUpperCase()}`;
                        errorMessage += `\nüîó Endpoint: ${apiEndpoint}`;
                        
                        if (this.currentEnvironment === 'dev') {
                            errorMessage += '\n\nüí° Tip: Make sure your local development server is running on port 3000';
                        } else {
                            errorMessage += '\n\nüí° Tip: Check if the production API server is accessible';
                        }
                    }
                    
                    this.showError(errorMessage);
                } finally {
                    this.showLoading(false);
                }
            }

            showResults() {
                this.renderSummary();
                this.renderInsights();
                this.renderCharts();
                this.renderDetailTables();
                
                document.getElementById('resultsSection').classList.remove('hidden');
            }

            renderSummary() {
                const stats = this.data.stats;
                const statsGrid = document.getElementById('statsGrid');

                const summaryStats = [
                    { label: 'Total Links', value: stats.totalLinks, color: '#667eea' },
                    { label: 'Intro Links', value: stats.totalIntroLinks, color: '#4CAF50' },
                    { label: 'Main Links', value: stats.totalMainLinks, color: '#2196F3' },
                    { label: 'Categories', value: Object.keys(stats.categoryCounts).length, color: '#FF9800' },
                ];

                // Calculate total available/unavailable/valid/invalid across ALL categories
                let totalAvailable = 0;
                let totalUnavailable = 0;
                let totalValid = 0;
                let totalInvalid = 0;
                let totalRedirected = 0;
                let totalValidationErrors = 0;
                let totalAvailabilityErrors = 0;

                // 1. Cruise Availability
                if (stats.cruiseAvailability) {
                    totalAvailable += stats.cruiseAvailability.available || 0;
                    totalUnavailable += stats.cruiseAvailability.unavailable || 0;
                    totalValidationErrors += stats.cruiseAvailability.errors || 0;
                }

                // 2. Tour With ID Validation (MISSING FROM ORIGINAL)
                if (stats.tourWithIdValidation) {
                    totalAvailable += stats.tourWithIdValidation.available || 0;
                    totalUnavailable += stats.tourWithIdValidation.unavailable || 0;
                    totalValid += stats.tourWithIdValidation.valid || 0;
                    totalInvalid += stats.tourWithIdValidation.invalid || 0;
                    totalRedirected += stats.tourWithIdValidation.redirected || 0;
                    totalValidationErrors += stats.tourWithIdValidation.validationErrors || 0;
                    totalAvailabilityErrors += stats.tourWithIdValidation.availabilityErrors || 0;
                }

                // 3. Tour Activity Validation
                if (stats.tourActivityValidation) {
                    totalAvailable += stats.tourActivityValidation.available || 0;
                    totalUnavailable += stats.tourActivityValidation.unavailable || 0;
                    totalValid += stats.tourActivityValidation.valid || 0;
                    totalInvalid += stats.tourActivityValidation.invalid || 0;
                    totalRedirected += stats.tourActivityValidation.redirected || 0;
                    totalValidationErrors += stats.tourActivityValidation.validationErrors || 0;
                    totalAvailabilityErrors += stats.tourActivityValidation.availabilityErrors || 0;
                }

                // 4. Cruise Ship Validation
                if (stats.cruiseShipValidation) {
                    totalAvailable += stats.cruiseShipValidation.available || 0;
                    totalUnavailable += stats.cruiseShipValidation.unavailable || 0;
                    totalValid += stats.cruiseShipValidation.valid || 0;
                    totalInvalid += stats.cruiseShipValidation.invalid || 0;
                    totalRedirected += stats.cruiseShipValidation.redirected || 0;
                    totalValidationErrors += stats.cruiseShipValidation.validationErrors || 0;
                    totalAvailabilityErrors += stats.cruiseShipValidation.availabilityErrors || 0;
                }

                // 5. Destination Validation
                if (stats.destinationValidation) {
                    totalValid += stats.destinationValidation.valid || 0;
                    totalInvalid += stats.destinationValidation.invalid || 0;
                    totalRedirected += stats.destinationValidation.redirected || 0;
                    totalValidationErrors += stats.destinationValidation.errors || 0;
                }

                // 6. Destination Special Page Validation (MISSING FROM ORIGINAL)
                if (stats.destinationSpecialPageValidation) {
                    totalValid += stats.destinationSpecialPageValidation.valid || 0;
                    totalInvalid += stats.destinationSpecialPageValidation.invalid || 0;
                    totalRedirected += stats.destinationSpecialPageValidation.redirected || 0;
                    totalValidationErrors += stats.destinationSpecialPageValidation.validationErrors || 0;
                }

                // 7. Story Validation
                if (stats.storyValidation) {
                    totalAvailable += stats.storyValidation.available || 0;
                    totalUnavailable += stats.storyValidation.unavailable || 0;
                    totalValid += stats.storyValidation.valid || 0;
                    totalInvalid += stats.storyValidation.invalid || 0;
                    totalRedirected += stats.storyValidation.redirected || 0;
                    totalValidationErrors += stats.storyValidation.validationErrors || 0;
                    totalAvailabilityErrors += stats.storyValidation.availabilityErrors || 0;
                }

                // 8. Contact Page Validation
                if (stats.contactPageValidation) {
                    totalAvailable += stats.contactPageValidation.available || 0;
                    totalUnavailable += stats.contactPageValidation.unavailable || 0;
                    totalValid += stats.contactPageValidation.valid || 0;
                    totalInvalid += stats.contactPageValidation.invalid || 0;
                    totalRedirected += stats.contactPageValidation.redirected || 0;
                    totalValidationErrors += stats.contactPageValidation.validationErrors || 0;
                    totalAvailabilityErrors += stats.contactPageValidation.availabilityErrors || 0;
                }

                // 9. Wrong Contact Path Validation
                if (stats.wrongContactPathValidation) {
                    // Wrong paths are always considered invalid
                    totalInvalid += stats.wrongContactPathValidation.total || 0;
                    totalValidationErrors += stats.wrongContactPathValidation.validationErrors || 0;
                }

                // 10. External Link Validation
                if (stats.externalLinkValidation) {
                    totalAvailable += stats.externalLinkValidation.available || 0;
                    totalUnavailable += stats.externalLinkValidation.unavailable || 0;
                    totalValid += stats.externalLinkValidation.valid || 0;
                    totalInvalid += stats.externalLinkValidation.invalid || 0;
                    totalRedirected += stats.externalLinkValidation.redirected || 0;
                    totalValidationErrors += stats.externalLinkValidation.validationErrors || 0;
                    totalAvailabilityErrors += stats.externalLinkValidation.availabilityErrors || 0;
                }

                // Add comprehensive summary stats
                if (totalAvailable > 0 || totalUnavailable > 0) {
                    summaryStats.push(
                        { label: 'Available Content', value: totalAvailable, color: '#4CAF50' },
                        { label: 'Unavailable Content', value: totalUnavailable, color: '#f44336' }
                    );
                }

                if (totalValid > 0 || totalInvalid > 0) {
                    summaryStats.push(
                        { label: 'Working Pages', value: totalValid, color: '#4CAF50' },
                        { label: 'Broken Pages', value: totalInvalid, color: '#f44336' }
                    );
                }

                if (totalRedirected > 0) {
                    summaryStats.push(
                        { label: 'Redirected Pages', value: totalRedirected, color: '#FF9800' }
                    );
                }

                // Add error summary if there are errors
                const totalErrorsFound = totalValidationErrors + totalAvailabilityErrors;
                if (totalErrorsFound > 0) {
                    summaryStats.push(
                        { label: 'Total Errors Found', value: totalErrorsFound, color: '#9C27B0' }
                    );
                }

                // Add specific category breakdown
                const categoryBreakdown = [];

                if (stats.cruiseAvailability && stats.cruiseAvailability.total > 0) {
                    categoryBreakdown.push(
                        { label: 'Cruise Availability', value: stats.cruiseAvailability.total, color: '#00BCD4' }
                    );
                }

                if (stats.tourWithIdValidation && stats.tourWithIdValidation.total > 0) {
                    categoryBreakdown.push(
                        { label: 'Tours with ID', value: stats.tourWithIdValidation.total, color: '#673AB7' }
                    );
                }

                if (stats.tourActivityValidation && stats.tourActivityValidation.total > 0) {
                    categoryBreakdown.push(
                        { label: 'Tour Activities', value: stats.tourActivityValidation.total, color: '#009688' }
                    );
                }

                if (stats.cruiseShipValidation && stats.cruiseShipValidation.total > 0) {
                    categoryBreakdown.push(
                        { label: 'Cruise Ships', value: stats.cruiseShipValidation.total, color: '#3F51B5' }
                    );
                }

                if (stats.destinationValidation && stats.destinationValidation.total > 0) {
                    categoryBreakdown.push(
                        { label: 'Destinations', value: stats.destinationValidation.total, color: '#8BC34A' }
                    );
                }

                if (stats.destinationSpecialPageValidation && stats.destinationSpecialPageValidation.total > 0) {
                    categoryBreakdown.push(
                        { label: 'Special Pages', value: stats.destinationSpecialPageValidation.total, color: '#CDDC39' }
                    );
                }

                if (stats.storyValidation && stats.storyValidation.total > 0) {
                    categoryBreakdown.push(
                        { label: 'Stories/Articles', value: stats.storyValidation.total, color: '#FF5722' }
                    );
                }

                if (stats.contactPageValidation && stats.contactPageValidation.total > 0) {
                    categoryBreakdown.push(
                        { label: 'Contact Pages', value: stats.contactPageValidation.total, color: '#607D8B' }
                    );
                }

                if (stats.wrongContactPathValidation && stats.wrongContactPathValidation.total > 0) {
                    categoryBreakdown.push(
                        { label: 'Wrong Contact Paths', value: stats.wrongContactPathValidation.total, color: '#E91E63' }
                    );
                }

                if (stats.externalLinkValidation && stats.externalLinkValidation.total > 0) {
                    categoryBreakdown.push(
                        { label: 'External Links', value: stats.externalLinkValidation.total, color: '#795548' }
                    );
                }

                // Add category breakdown to summary
                summaryStats.push(...categoryBreakdown);

                statsGrid.innerHTML = summaryStats.map(stat => `
                    <div class="stat-card">
                        <div class="stat-value" style="color: ${stat.color}">${stat.value}</div>
                        <div class="stat-label">${stat.label}</div>
                    </div>
                `).join('');
            }

            // Enhanced renderInsights() function with copyable report format
            renderInsights() {
                const stats = this.data.stats;
                const detailedResults = this.data.detailedResults;
                const insights = [];
                const destination = this.extractDestinationFromUrl(this.auditUrl);

                // Collect all problematic links with details
                const problemLinks = {
                    unavailable: [],
                    invalid: [],
                    wrongPaths: [],
                    redirected: [],
                    errors: [],
                    lackingVariation: [],
                    // Specific unavailable content categories
                    toursNoPrice: [],           
                    cruisesNoPrice: [],         
                    cruiseShipsNotAvailable: [], 
                    tourActivitiesNotAvailable: []
                };

                // Check for sections with excessive duplicate titles
                if (detailedResults && detailedResults.sectionBreakdown) {
                    detailedResults.sectionBreakdown.forEach(function(section) {
                        if (section.titleGroups && section.titleGroups.length > 0) {
                            const titleCounts = {};
                            section.titleGroups.forEach(function(titleGroup) {
                                const title = titleGroup.title;
                                titleCounts[title] = (titleCounts[title] || 0) + 1;
                            });

                            const excessiveDuplicates = Object.keys(titleCounts).filter(function(title) {
                                return titleCounts[title] > 3;
                            });
                            
                            if (excessiveDuplicates.length > 0) {
                                excessiveDuplicates.forEach(function(title) {
                                    problemLinks.lackingVariation.push({
                                        section: section.section,
                                        title: title,
                                        count: titleCounts[title],
                                        reason: 'Section content lacks variety - same title appears ' + titleCounts[title] + ' times'
                                    });
                                });
                            }
                        }
                    });
                }

                // Process all categories for detailed error collection
                if (detailedResults) {
                    Object.keys(detailedResults).forEach(function(category) {
                        if (category === 'sectionBreakdown') return;
                        
                        const links = detailedResults[category] || [];
                        
                        links.forEach(function(link) {
                            const linkInfo = {
                                text: link.text,
                                href: link.href,
                                category: category,
                                error: link.error || link.validationError || link.availabilityError,
                                urlPattern: link.urlPattern
                            };

                            // Helper to distinguish content errors from technical errors
                            const isContentError = link.availabilityError && (
                                link.availabilityError.toLowerCase().indexOf('pricing') !== -1 ||
                                link.availabilityError.toLowerCase().indexOf('price') !== -1 ||
                                link.availabilityError.toLowerCase().indexOf('not found') !== -1 ||
                                link.availabilityError.toLowerCase().indexOf('not available') !== -1
                            );

                            // Classification logic (same as before)
                            if (category === 'wrongContactPathLinks' || category === 'wrong-contact-path') {
                                problemLinks.wrongPaths.push({
                                    ...linkInfo,
                                    reason: 'Wrong contact page path (likely should be /contact instead)'
                                });
                            }
                            else if (link.available === false && link.valid !== false && (!link.availabilityError || isContentError)) {
                                if (link.urlPattern === 'tour-with-id' || category === 'tourWithIdLinks') {
                                    problemLinks.toursNoPrice.push({
                                        ...linkInfo,
                                        reason: 'Tour has no price content or price is $0',
                                        tourId: link.tourId || 'Unknown',
                                        priceText: link.priceText || 'Not found',
                                        price: link.price || null
                                    });
                                }
                                else if (link.urlPattern === 'cruise-with-id' || category === 'cruiseLinks') {
                                    problemLinks.cruisesNoPrice.push({
                                        ...linkInfo,
                                        reason: 'Cruise has no price content or price is $0',
                                        cruiseId: link.cruiseId || 'Unknown',
                                        priceText: link.priceText || 'Not found',
                                        price: link.price || null
                                    });
                                }
                                else if (link.urlPattern === 'cruise-ship' || category === 'cruiseShipLinks') {
                                    problemLinks.cruiseShipsNotAvailable.push({
                                        ...linkInfo,
                                        reason: 'Cruise ship not found in destination ship list',
                                        shipName: link.shipName || 'Unknown',
                                        shipOptions: link.shipOptions || [],
                                        toursUrl: link.toursUrl || 'Unknown'
                                    });
                                }
                                else if (link.urlPattern === 'tour-activity' || category === 'tourActivityLinks') {
                                    problemLinks.tourActivitiesNotAvailable.push({
                                        ...linkInfo,
                                        reason: 'Tour activity not found in experience or activity option lists',
                                        activityText: link.activityText || 'Unknown',
                                        experienceOptions: link.experienceOptions || [],
                                        activityOptions: link.activityOptions || []
                                    });
                                }
                                else {
                                    problemLinks.unavailable.push({
                                        ...linkInfo,
                                        reason: 'Content unavailable or not found on page'
                                    });
                                }
                            }
                            else if (link.valid === false || link.validationError || (link.availabilityError && !isContentError)) {
                                problemLinks.invalid.push({
                                    ...linkInfo,
                                    reason: (link.availabilityError && !isContentError) ? link.availabilityError : (link.validationError || 'Page validation failed')
                                });
                            }
                            else if (link.redirected === true) {
                                problemLinks.redirected.push({
                                    ...linkInfo,
                                    reason: 'Page redirects to different URL'
                                });
                            }
                            else if (link.error) {
                                problemLinks.errors.push({
                                    ...linkInfo,
                                    reason: link.error
                                });
                            }
                        });
                    });
                }

                // Build insights array
                if (problemLinks.wrongPaths.length > 0) {
                    insights.push({
                        type: 'error',
                        title: 'Wrong Contact Paths',
                        count: problemLinks.wrongPaths.length,
                        items: problemLinks.wrongPaths,
                        priority: 'high',
                        icon: 'üö®'
                    });
                }

                if (problemLinks.toursNoPrice.length > 0) {
                    insights.push({
                        type: 'warning',
                        title: 'Tours with No Price Content',
                        count: problemLinks.toursNoPrice.length,
                        items: problemLinks.toursNoPrice,
                        priority: 'high',
                        icon: 'üéØ'
                    });
                }

                if (problemLinks.cruisesNoPrice.length > 0) {
                    insights.push({
                        type: 'warning', 
                        title: 'Cruises with No Price Content',
                        count: problemLinks.cruisesNoPrice.length,
                        items: problemLinks.cruisesNoPrice,
                        priority: 'high',
                        icon: 'üõ≥Ô∏è'
                    });
                }

                if (problemLinks.cruiseShipsNotAvailable.length > 0) {
                    insights.push({
                        type: 'warning',
                        title: 'Cruise Ships Not Available',
                        count: problemLinks.cruiseShipsNotAvailable.length,
                        items: problemLinks.cruiseShipsNotAvailable,
                        priority: 'high',
                        icon: 'üö¢'
                    });
                }

                if (problemLinks.tourActivitiesNotAvailable.length > 0) {
                    insights.push({
                        type: 'warning',
                        title: 'Tour Activities Not Available',
                        count: problemLinks.tourActivitiesNotAvailable.length,
                        items: problemLinks.tourActivitiesNotAvailable,
                        priority: 'high',
                        icon: 'üé™'
                    });
                }

                if (problemLinks.unavailable.length > 0) {
                    insights.push({
                        type: 'warning',
                        title: 'Other Unavailable Content',
                        count: problemLinks.unavailable.length,
                        items: problemLinks.unavailable,
                        priority: 'medium',
                        icon: '‚ùå'
                    });
                }

                if (problemLinks.invalid.length > 0) {
                    insights.push({
                        type: 'warning',
                        title: 'Broken Pages',
                        count: problemLinks.invalid.length,
                        items: problemLinks.invalid,
                        priority: 'medium',
                        icon: 'üîó'
                    });
                }

                if (problemLinks.redirected.length > 0) {
                    insights.push({
                        type: 'info',
                        title: 'Pages That Have Moved',
                        count: problemLinks.redirected.length,
                        items: problemLinks.redirected,
                        priority: 'low',
                        icon: '‚ÜóÔ∏è'
                    });
                }

                if (problemLinks.lackingVariation.length > 0) {
                    insights.push({
                        type: 'info',
                        title: 'Content Variety Issues',
                        count: problemLinks.lackingVariation.length,
                        items: problemLinks.lackingVariation,
                        priority: 'medium',
                        icon: 'üìù'
                    });
                }

                if (problemLinks.errors.length > 0) {
                    insights.push({
                        type: 'error',
                        title: 'Other Issues',
                        count: problemLinks.errors.length,
                        items: problemLinks.errors,
                        priority: 'medium',
                        icon: '‚ö†Ô∏è'
                    });
                }

                // Generate copyable report
                const reportText = this.generateCopyableReport(destination, insights, stats);

                // Display insights
                const insightsPanel = document.getElementById('insightsPanel');
                const insightsContent = document.getElementById('insightsContent');

                if (insights.length > 0) {
                    insights.sort(function(a, b) {
                        const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                        return priorityOrder[a.priority] - priorityOrder[b.priority];
                    });

                    const totalIssues = insights.reduce(function(sum, insight) {
                        return sum + insight.count;
                    }, 0);

                    const headerHtml = 
                        '<div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; position: relative;">' +
                            '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                                '<div>' +
                                    '<h4 style="margin: 0 0 0.5rem 0; color: #856404;">' +
                                        'üìä Total Issues Found: <span style="color: #d32f2f; font-size: 1.2em;">' + totalIssues + '</span>' +
                                    '</h4>' +
                                    '<p style="margin: 0; color: #856404; font-size: 14px;">' +
                                        'Comprehensive report ready for documentation' +
                                    '</p>' +
                                '</div>' +
                                '<div>' +
                                    '<button id="copyReportBtn" style="background: #2196F3; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 0.5rem;">' +
                                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">' +
                                            '<path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>' +
                                        '</svg>' +
                                        'Copy Report' +
                                    '</button>' +
                                '</div>' +
                            '</div>' +
                        '</div>';

                    insightsContent.innerHTML = headerHtml + insights.map(function(insight) {
                        const color = insight.type === 'error' ? '#f44336' : 
                                     insight.type === 'warning' ? '#FF9800' : '#2196F3';
                        const bgColor = insight.type === 'error' ? '#ffebee' : 
                                       insight.type === 'warning' ? '#fff3e0' : '#e3f2fd';
                        const textColor = insight.type === 'error' ? '#c62828' : 
                                         insight.type === 'warning' ? '#ef6c00' : '#1976d2';

                        return (
                            '<div style="margin-bottom: 1.5rem; border: 2px solid ' + color + '; border-radius: 8px; overflow: hidden;">' +
                                '<div style="background: ' + color + '; color: white; padding: 0.75rem; font-weight: bold;">' +
                                    insight.icon + ' ' + insight.title + ' (' + insight.count + ')' +
                                    '<span style="float: right; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.85em;">' +
                                        'Priority: ' + insight.priority.toUpperCase() +
                                    '</span>' +
                                '</div>' +
                                '<div style="background: ' + bgColor + '; padding: 1rem; max-height: 300px; overflow-y: auto;">' +
                                    insight.items.map(function(item, index) {
                                        return (
                                            '<div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 6px; border-left: 4px solid ' + color + ';">' +
                                                '<div style="font-weight: bold; color: ' + textColor + '; margin-bottom: 0.5rem;">' +
                                                    (index + 1) + '. ' + (item.text || 'No title') +
                                                '</div>' +
                                                '<div style="font-family: monospace; font-size: 0.85em; color: #666; margin-bottom: 0.5rem; word-break: break-all;">' +
                                                    'üîó ' + item.href +
                                                '</div>' +
                                                '<div style="color: ' + textColor + '; font-size: 0.9em; margin-bottom: 0.5rem;">' +
                                                    '<strong>Issue:</strong> ' + item.reason +
                                                '</div>' +
                                                (item.tourId ? '<div style="font-size: 0.85em; color: #666;"><strong>Tour ID:</strong> ' + item.tourId + ' | <strong>Price Found:</strong> ' + item.priceText + '</div>' : '') +
                                                (item.cruiseId ? '<div style="font-size: 0.85em; color: #666;"><strong>Cruise ID:</strong> ' + item.cruiseId + ' | <strong>Price Found:</strong> ' + item.priceText + '</div>' : '') +
                                                (item.shipName ? '<div style="font-size: 0.85em; color: #666;"><strong>Ship Name:</strong> ' + item.shipName + ' | <strong>Available Ships:</strong> ' + item.shipOptions.length + '</div>' : '') +
                                                (item.activityText ? '<div style="font-size: 0.85em; color: #666;"><strong>Activity:</strong> ' + item.activityText + ' | <strong>Options Found:</strong> ' + (item.experienceOptions.length + item.activityOptions.length) + '</div>' : '') +
                                            '</div>'
                                        );
                                    }).join('') +
                                '</div>' +
                            '</div>'
                        );
                    }).join('');
                    
                    insightsPanel.style.display = 'block';

                    // Add copy functionality - VERSION 2 with HTML and Plain Text
                    const copyBtn = document.getElementById('copyReportBtn');
                    const self = this; // Store reference for use in callback
                    if (copyBtn) {
                        copyBtn.addEventListener('click', function() {
                            // Generate both formats
                            const textReport = reportText;
                            const htmlReport = self.generateCopyableReportHTML(destination, insights, stats);
                            
                            // Try modern clipboard API first (with HTML support)
                            if (navigator.clipboard && navigator.clipboard.write) {
                                const clipboardItems = [
                                    new ClipboardItem({
                                        'text/html': new Blob([htmlReport], { type: 'text/html' }),
                                        'text/plain': new Blob([textReport], { type: 'text/plain' })
                                    })
                                ];
                                
                                navigator.clipboard.write(clipboardItems).then(function() {
                                    // Show success feedback
                                    const originalText = copyBtn.innerHTML;
                                    copyBtn.innerHTML = 
                                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">' +
                                            '<path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>' +
                                        '</svg>' +
                                        'Copied! (HTML + Text)';
                                    copyBtn.style.background = '#4CAF50';
                                    
                                    setTimeout(function() {
                                        copyBtn.innerHTML = originalText;
                                        copyBtn.style.background = '#2196F3';
                                    }, 3000);
                                }).catch(function(err) {
                                    console.warn('Modern clipboard API failed, falling back to text-only:', err);
                                    fallbackToTextOnly();
                                });
                            } else {
                                // Fallback for older browsers (text only)
                                fallbackToTextOnly();
                            }
                            
                            function fallbackToTextOnly() {
                                if (navigator.clipboard && navigator.clipboard.writeText) {
                                    navigator.clipboard.writeText(textReport).then(function() {
                                        // Show fallback success feedback
                                        const originalText = copyBtn.innerHTML;
                                        copyBtn.innerHTML = 
                                            '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">' +
                                                '<path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>' +
                                            '</svg>' +
                                            'Copied! (Text)';
                                        copyBtn.style.background = '#FF9800';
                                        
                                        setTimeout(function() {
                                            copyBtn.innerHTML = originalText;
                                            copyBtn.style.background = '#2196F3';
                                        }, 3000);
                                    }).catch(function(err) {
                                        console.error('All clipboard methods failed:', err);
                                        // Final fallback - show modal with text to copy manually
                                        showManualCopyModal(textReport);
                                    });
                                } else {
                                    // Final fallback for very old browsers
                                    showManualCopyModal(textReport);
                                }
                            }
                            
                            function showManualCopyModal(text) {
                                // Create modal for manual copy
                                const modal = document.createElement('div');
                                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                                
                                const modalContent = document.createElement('div');
                                modalContent.style.cssText = 'background: white; padding: 20px; border-radius: 8px; max-width: 80%; max-height: 80%; overflow: hidden;';
                                
                                modalContent.innerHTML = 
                                    '<h3 style="margin-top: 0;">Copy Report Manually</h3>' +
                                    '<p>Please copy the report text below:</p>' +
                                    '<textarea readonly style="width: 100%; height: 300px; font-family: monospace; font-size: 12px;">' + text + '</textarea>' +
                                    '<div style="margin-top: 15px; text-align: right;">' +
                                        '<button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>' +
                                    '</div>';
                                
                                modal.appendChild(modalContent);
                                document.body.appendChild(modal);
                                
                                // Select the text automatically
                                const textarea = modalContent.querySelector('textarea');
                                textarea.focus();
                                textarea.select();
                                
                                // Close modal when clicking outside
                                modal.addEventListener('click', function(e) {
                                    if (e.target === modal) {
                                        modal.remove();
                                    }
                                });
                            }
                        });
                    }
                    
                } else {
                    insightsContent.innerHTML = 
                        '<div style="background: #e8f5e8; border: 2px solid #4CAF50; border-radius: 8px; padding: 2rem; text-align: center;">' +
                            '<h3 style="color: #2e7d32; margin: 0 0 1rem 0;">üéâ Excellent! No Issues Found</h3>' +
                            '<p style="color: #388e3c; margin: 0; font-size: 1.1em;">' +
                                'All ' + (this.data.stats?.totalLinks || 0) + ' links are working correctly and have proper content!' +
                            '</p>' +
                        '</div>';
                    insightsPanel.style.display = 'block';
                }
            }

            // NEW: Generate copyable report text - CLEAN DOCUMENT STYLE
            generateCopyableReport(destination, insights, stats) {
                const currentDate = new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                const totalIssues = insights.reduce(function(sum, insight) {
                    return sum + insight.count;
                }, 0);

                let report = '';
                
                // Document Header
                report += 'LINK AUDIT REPORT\n\n';
                
                report += 'Destination: ' + destination + '\n';
                report += 'Audit Date: ' + currentDate + '\n';
                report += 'Audit URL: ' + this.auditUrl + '\n';
                report += 'Total Links Analyzed: ' + (stats?.totalLinks || 0) + '\n';
                report += 'Total Issues Found: ' + totalIssues + '\n\n\n';
                
                if (totalIssues === 0) {
                    report += 'EXECUTIVE SUMMARY\n\n';
                    report += 'Excellent! All ' + (stats?.totalLinks || 0) + ' links are working correctly and have proper content. No issues were found during this audit.\n\n';
                    return report;
                }
                
                // Executive Summary
                report += 'EXECUTIVE SUMMARY\n\n';
                
                const highPriorityCount = insights.filter(i => i.priority === 'high').reduce((sum, i) => sum + i.count, 0);
                const mediumPriorityCount = insights.filter(i => i.priority === 'medium').reduce((sum, i) => sum + i.count, 0);
                const lowPriorityCount = insights.filter(i => i.priority === 'low').reduce((sum, i) => sum + i.count, 0);
                
                report += 'This audit identified ' + totalIssues + ' issues across ' + insights.length + ' categories.\n\n';
                
                // Priority Breakdown
                report += 'Priority Breakdown:\n\n';
                if (highPriorityCount > 0) {
                    report += '‚Ä¢ High Priority: ' + highPriorityCount + ' issue' + (highPriorityCount === 1 ? '' : 's') + ' (Immediate attention required)\n\n';
                }
                if (mediumPriorityCount > 0) {
                    report += '‚Ä¢ Medium Priority: ' + mediumPriorityCount + ' issue' + (mediumPriorityCount === 1 ? '' : 's') + ' (Address when convenient)\n\n';
                }
                if (lowPriorityCount > 0) {
                    report += '‚Ä¢ Low Priority: ' + lowPriorityCount + ' issue' + (lowPriorityCount === 1 ? '' : 's') + ' (Minor optimization)\n\n';
                }
                report += '\n';
                
                // Detailed Findings
                report += 'DETAILED FINDINGS\n\n';
                
                insights.forEach(function(insight, insightIndex) {
                    report += (insightIndex + 1) + '. ' + insight.title + '\n\n';
                    report += 'Total Issues: ' + insight.count + '\n';
                    report += 'Priority: ' + insight.priority.charAt(0).toUpperCase() + insight.priority.slice(1) + '\n\n';
                    
                    insight.items.forEach(function(item, itemIndex) {
                        report += 'Issue ' + (itemIndex + 1) + ':\n';
                        report += 'Title: ' + (item.text || 'No title') + '\n';
                        report += 'URL: ' + item.href + '\n';
                        report += 'Problem: ' + item.reason + '\n';
                        
                        // Add specific details based on type
                        if (item.tourId) {
                            report += 'Tour ID: ' + item.tourId + '\n';
                            report += 'Price Status: ' + item.priceText + '\n';
                        }
                        if (item.cruiseId) {
                            report += 'Cruise ID: ' + item.cruiseId + '\n';
                            report += 'Price Status: ' + item.priceText + '\n';
                        }
                        if (item.shipName) {
                            report += 'Ship Name: ' + item.shipName + '\n';
                            report += 'Available Ships: ' + item.shipOptions.length + '\n';
                        }
                        if (item.activityText) {
                            report += 'Activity: ' + item.activityText + '\n';
                            report += 'Options Found: ' + (item.experienceOptions.length + item.activityOptions.length) + '\n';
                        }
                        
                        report += 'Category: ' + item.category + '\n\n';
                    });
                });
                
                // Recommended Actions
                report += 'RECOMMENDED ACTIONS\n\n';
                
                let actionCounter = 1;
                
                const highPriorityIssues = insights.filter(i => i.priority === 'high');
                if (highPriorityIssues.length > 0) {
                    report += 'Immediate Actions (High Priority):\n\n';
                    highPriorityIssues.forEach(function(insight) {
                        report += actionCounter + '. Fix ' + insight.title + '\n';
                        report += '   ‚Ä¢ ' + insight.count + ' link' + (insight.count === 1 ? '' : 's') + ' need immediate attention\n';
                        report += '   ‚Ä¢ Impact: High - affects user experience\n\n';
                        actionCounter++;
                    });
                }
                
                const mediumPriorityIssues = insights.filter(i => i.priority === 'medium');
                if (mediumPriorityIssues.length > 0) {
                    report += 'Scheduled Actions (Medium Priority):\n\n';
                    mediumPriorityIssues.forEach(function(insight) {
                        report += actionCounter + '. Address ' + insight.title + '\n';
                        report += '   ‚Ä¢ ' + insight.count + ' link' + (insight.count === 1 ? '' : 's') + ' to be fixed when convenient\n';
                        report += '   ‚Ä¢ Impact: Medium - plan for next maintenance window\n\n';
                        actionCounter++;
                    });
                }
                
                const lowPriorityIssues = insights.filter(i => i.priority === 'low');
                if (lowPriorityIssues.length > 0) {
                    report += 'Future Optimization (Low Priority):\n\n';
                    lowPriorityIssues.forEach(function(insight) {
                        report += actionCounter + '. Optimize ' + insight.title + '\n';
                        report += '   ‚Ä¢ ' + insight.count + ' item' + (insight.count === 1 ? '' : 's') + ' for future improvement\n';
                        report += '   ‚Ä¢ Impact: Low - enhancement opportunities\n\n';
                        actionCounter++;
                    });
                }
                
                // Document Footer
                report += 'Report generated on ' + currentDate + '\n';
                report += 'Generated by: Link Audit Dashboard\n';
                report += 'Contact: Web Development Team for questions';
                
                return report;
            }

            // NEW: Selective bold text, bigger headers, no category field
            generateCopyableReportHTML(destination, insights, stats) {
                const currentDate = new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                const totalIssues = insights.reduce(function(sum, insight) {
                    return sum + insight.count;
                }, 0);

                // Simple HTML with selective bold and bigger headers
                let html = '<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body style="font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 40px 20px; color: #333;">';
                
                // Document Header - Bigger font, selective bold
                html += '<h1 style="font-size: 2.8rem; font-weight: bold; margin-bottom: 30px; color: #2c3e50;">Link Audit Report</h1>';
                
                html += '<p style="margin: 8px 0;"><strong>Destination:</strong> ' + destination + '</p>';
                html += '<p style="margin: 8px 0;"><strong>Audit Date:</strong> ' + currentDate + '</p>';
                html += '<p style="margin: 8px 0;"><strong>Audit URL:</strong> <a href="' + this.auditUrl + '" style="color: #667eea; text-decoration: none;">' + this.auditUrl + '</a></p>';
                html += '<p style="margin: 8px 0;"><strong>Total Links Analyzed:</strong> ' + (stats?.totalLinks || 0) + '</p>';
                html += '<p style="margin: 8px 0;"><strong>Total Issues Found:</strong> ' + totalIssues + '</p>';
                
                if (totalIssues === 0) {
                    html += '<p style="margin: 20px 0;">Excellent! All links are working correctly and have proper content. No issues were found during this audit.</p>';
                    html += '<br>';
                    html += '<p style="margin: 8px 0;">Report generated on ' + currentDate + '</p>';
                    html += '<p style="margin: 8px 0;">Generated by: Link Audit Dashboard</p>';
                    html += '<p style="margin: 8px 0;">Contact: Web Development Team for questions</p>';
                    html += '</body></html>';
                    return html;
                }
                
                // Detailed Findings - Bigger header
                html += '<h2 style="font-size: 2rem; font-weight: bold; margin: 40px 0 20px 0; color: #2c3e50;">Detailed Findings</h2>';
                
                insights.forEach(function(insight, insightIndex) {
                    html += '<p style="margin: 20px 0 8px 0; font-size: 1.3rem;"><strong>' + (insightIndex + 1) + '. ' + insight.title + '</strong></p>';
                    html += '<p style="margin: 8px 0 8px 0;">Total Issues: ' + insight.count + '</p>';
                    html += '<p style="margin: 8px 0 20px 0;">Priority: ' + insight.priority.charAt(0).toUpperCase() + insight.priority.slice(1) + '</p>';
                    
                    insight.items.forEach(function(item, itemIndex) {
                        html += '<div style="margin-left: 20px; margin-bottom: 20px;">';
                        html += '<p style="margin: 8px 0;"><strong>Issue ' + (itemIndex + 1) + ': ' + (item.text || 'No title') + '</strong></p>';
                        html += '<p style="margin: 8px 0; margin-left: 20px;"><a href="' + item.href + '" style="color: #667eea; text-decoration: none; word-break: break-all;">' + item.href + '</a></p>';
                        html += '<p style="margin: 8px 0; margin-left: 20px;">Problem: ' + item.reason + '</p>';
                        
                        // Add specific details with indentation (NO CATEGORY)
                        if (item.tourId) {
                            html += '<p style="margin: 8px 0; margin-left: 20px;">Tour ID: ' + item.tourId + '</p>';
                            html += '<p style="margin: 8px 0; margin-left: 20px;">Price Status: ' + item.priceText + '</p>';
                        }
                        if (item.cruiseId) {
                            html += '<p style="margin: 8px 0; margin-left: 20px;">Cruise ID: ' + item.cruiseId + '</p>';
                            html += '<p style="margin: 8px 0; margin-left: 20px;">Price Status: ' + item.priceText + '</p>';
                        }
                        if (item.shipName) {
                            html += '<p style="margin: 8px 0; margin-left: 20px;">Ship Name: ' + item.shipName + '</p>';
                            html += '<p style="margin: 8px 0; margin-left: 20px;">Available Ships: ' + item.shipOptions.length + '</p>';
                        }
                        if (item.activityText) {
                            html += '<p style="margin: 8px 0; margin-left: 20px;">Activity: ' + item.activityText + '</p>';
                            html += '<p style="margin: 8px 0; margin-left: 20px;">Options Found: ' + (item.experienceOptions.length + item.activityOptions.length) + '</p>';
                        }
                        // REMOVED: Category field is no longer included
                        html += '</div>';
                    });
                });
                
                // Document Footer with spacing
                html += '<div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">';
                html += '<p style="margin: 8px 0;">Report generated on ' + currentDate + '</p>';
                html += '<p style="margin: 8px 0;">Generated by: Link Audit Dashboard</p>';
                html += '<p style="margin: 8px 0;">Contact: Web Development Team for questions</p>';
                html += '</div>';
                
                html += '</body></html>';
                
                return html;
            }

            renderCharts() {
                this.destroyCharts();
                
                // Category Chart
                this.renderCategoryChart();
                
                // Availability Chart
                this.renderAvailabilityChart();
                
                // Validation Chart
                this.renderValidationChart();
                
                // Source Chart
                this.renderSourceChart();
            }

            renderCategoryChart() {
                const ctx = document.getElementById('categoryChart').getContext('2d');
                const categories = this.data.stats.categoryCounts;

                this.charts.category = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categories),
                        datasets: [{
                            data: Object.values(categories),
                            backgroundColor: [
                                '#667eea', '#764ba2', '#f093fb', '#f5576c',
                                '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                                '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            renderAvailabilityChart() {
                const ctx = document.getElementById('availabilityChart').getContext('2d');
                const stats = this.data.stats;
                
                const availabilityData = {
                    'Available': 0,
                    'Unavailable': 0,
                    'Unknown': 0
                };

                // Aggregate availability data from ALL sources (including missing ones)
                if (stats.cruiseAvailability) {
                    availabilityData.Available += stats.cruiseAvailability.available || 0;
                    availabilityData.Unavailable += stats.cruiseAvailability.unavailable || 0;
                }

                // ADDED: tourWithIdValidation (was missing)
                if (stats.tourWithIdValidation) {
                    availabilityData.Available += stats.tourWithIdValidation.available || 0;
                    availabilityData.Unavailable += stats.tourWithIdValidation.unavailable || 0;
                }

                if (stats.tourActivityValidation) {
                    availabilityData.Available += stats.tourActivityValidation.available || 0;
                    availabilityData.Unavailable += stats.tourActivityValidation.unavailable || 0;
                }

                if (stats.cruiseShipValidation) {
                    availabilityData.Available += stats.cruiseShipValidation.available || 0;
                    availabilityData.Unavailable += stats.cruiseShipValidation.unavailable || 0;
                }

                if (stats.storyValidation) {
                    availabilityData.Available += stats.storyValidation.available || 0;
                    availabilityData.Unavailable += stats.storyValidation.unavailable || 0;
                }

                if (stats.contactPageValidation) {
                    availabilityData.Available += stats.contactPageValidation.available || 0;
                    availabilityData.Unavailable += stats.contactPageValidation.unavailable || 0;
                }

                if (stats.externalLinkValidation) {
                    availabilityData.Available += stats.externalLinkValidation.available || 0;
                    availabilityData.Unavailable += stats.externalLinkValidation.unavailable || 0;
                }

                // Wrong paths are always considered unavailable
                if (stats.wrongContactPathValidation) {
                    availabilityData.Unavailable += stats.wrongContactPathValidation.total || 0;
                }

                const totalTested = availabilityData.Available + availabilityData.Unavailable;
                availabilityData.Unknown = Math.max(0, stats.totalLinks - totalTested);

                this.charts.availability = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(availabilityData),
                        datasets: [{
                            label: 'Links',
                            data: Object.values(availabilityData),
                            backgroundColor: ['#4CAF50', '#f44336', '#9E9E9E']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            renderValidationChart() {
                const ctx = document.getElementById('validationChart').getContext('2d');
                const stats = this.data.stats;
                
                const validationData = {
                    'Valid': 0,
                    'Invalid': 0,
                    'Redirected': 0
                };

                // Aggregate validation data from ALL sources (including missing ones)
                if (stats.destinationValidation) {
                    validationData.Valid += stats.destinationValidation.valid || 0;
                    validationData.Invalid += stats.destinationValidation.invalid || 0;
                    validationData.Redirected += stats.destinationValidation.redirected || 0;
                }

                // ADDED: tourWithIdValidation (was missing)
                if (stats.tourWithIdValidation) {
                    validationData.Valid += stats.tourWithIdValidation.valid || 0;
                    validationData.Invalid += stats.tourWithIdValidation.invalid || 0;
                    validationData.Redirected += stats.tourWithIdValidation.redirected || 0;
                }

                if (stats.tourActivityValidation) {
                    validationData.Valid += stats.tourActivityValidation.valid || 0;
                    validationData.Invalid += stats.tourActivityValidation.invalid || 0;
                    validationData.Redirected += stats.tourActivityValidation.redirected || 0;
                }

                if (stats.cruiseShipValidation) {
                    validationData.Valid += stats.cruiseShipValidation.valid || 0;
                    validationData.Invalid += stats.cruiseShipValidation.invalid || 0;
                    validationData.Redirected += stats.cruiseShipValidation.redirected || 0;
                }

                // ADDED: destinationSpecialPageValidation (was missing)
                if (stats.destinationSpecialPageValidation) {
                    validationData.Valid += stats.destinationSpecialPageValidation.valid || 0;
                    validationData.Invalid += stats.destinationSpecialPageValidation.invalid || 0;
                    validationData.Redirected += stats.destinationSpecialPageValidation.redirected || 0;
                }

                if (stats.storyValidation) {
                    validationData.Valid += stats.storyValidation.valid || 0;
                    validationData.Invalid += stats.storyValidation.invalid || 0;
                    validationData.Redirected += stats.storyValidation.redirected || 0;
                }

                if (stats.contactPageValidation) {
                    validationData.Valid += stats.contactPageValidation.valid || 0;
                    validationData.Invalid += stats.contactPageValidation.invalid || 0;
                    validationData.Redirected += stats.contactPageValidation.redirected || 0;
                }

                // Wrong contact paths are always invalid
                if (stats.wrongContactPathValidation) {
                    validationData.Invalid += stats.wrongContactPathValidation.total || 0;
                }

                if (stats.externalLinkValidation) {
                    validationData.Valid += stats.externalLinkValidation.valid || 0;
                    validationData.Invalid += stats.externalLinkValidation.invalid || 0;
                    validationData.Redirected += stats.externalLinkValidation.redirected || 0;
                }

                this.charts.validation = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(validationData),
                        datasets: [{
                            data: Object.values(validationData),
                            backgroundColor: ['#4CAF50', '#f44336', '#FF9800']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            renderSourceChart() {
                const ctx = document.getElementById('sourceChart').getContext('2d');
                const stats = this.data.stats;

                this.charts.source = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Intro Section', 'Main Section'],
                        datasets: [{
                            data: [stats.totalIntroLinks, stats.totalMainLinks],
                            backgroundColor: ['#667eea', '#4CAF50']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            renderDetailTables() {
                this.renderDetailView('section');
                this.renderDetailView('urlpattern');
            }

            renderDetailView(viewType) {
                if (viewType === 'section') {
                    this.renderSectionView();
                } else if (viewType === 'urlpattern') {
                    this.renderUrlPatternView();
                }
            }

            renderSectionView() {
                const container = document.getElementById('sectionView');
                container.innerHTML = '';

                if (this.data.detailedResults && this.data.detailedResults.sectionBreakdown) {
                    this.renderSectionBasedTables(container);
                } else if (this.data.linksBySection) {
                    this.renderLinksBySection(container);
                } else {
                    container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">Section data not available in this API version</div>';
                }
            }

            renderUrlPatternView() {
                const container = document.getElementById('urlpatternView');
                container.innerHTML = '';

                if (this.data.linksByCategory) {
                    this.renderUrlPatternBasedTables(container);
                } else {
                    container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">URL pattern data not available</div>';
                }
            }

            renderLinksBySection(container) {
                const linksBySection = this.data.linksBySection;
                
                Object.keys(linksBySection).forEach(sectionType => {
                    const titleGroups = linksBySection[sectionType];
                    if (titleGroups && titleGroups.length > 0) {
                        const sectionData = {
                            section: sectionType,
                            totalLinks: titleGroups.reduce((sum, group) => sum + group.links.length, 0),
                            categories: {},
                            titleGroups: titleGroups
                        };
                        
                        titleGroups.forEach(group => {
                            group.links.forEach(link => {
                                const category = link.category || 'unknown';
                                sectionData.categories[category] = (sectionData.categories[category] || 0) + 1;
                            });
                        });

                        const sectionHtml = this.createSectionTable(sectionData);
                        container.insertAdjacentHTML('beforeend', sectionHtml);
                    }
                });
            }

            renderUrlPatternBasedTables(container) {
                const urlPatterns = Object.keys(this.data.linksByCategory);
                
                if (urlPatterns.length > 1) {
                    const patternNav = `
                        <div class="table-container" style="margin-bottom: 1rem;">
                            <div class="table-header">
                                <h3>üîó Navigate to URL Pattern</h3>
                            </div>
                            <div style="padding: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${urlPatterns.map(pattern => `
                                    <button class="btn btn-secondary" onclick="document.getElementById('pattern-${this.sanitizeId(pattern)}').scrollIntoView({behavior: 'smooth'})">
                                        ${pattern} (${this.data.linksByCategory[pattern].length})
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', patternNav);
                }

                urlPatterns.forEach(pattern => {
                    const links = this.data.linksByCategory[pattern];
                    if (links && links.length > 0) {
                        const patternHtml = this.createUrlPatternTable(pattern, links);
                        container.insertAdjacentHTML('beforeend', patternHtml);
                    }
                });
            }

            createUrlPatternTable(pattern, links) {
                const patternId = `pattern-${this.sanitizeId(pattern)}`;
                const tableId = `table-${this.sanitizeId(pattern)}`;
                
                return `
                    <div class="table-container" id="${patternId}" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3>üîó ${pattern} (${links.length} links)</h3>
                            <div style="margin-top: 0.5rem;">
                                <input type="text" placeholder="Search in this pattern..." 
                                       onkeyup="filterTable('${tableId}', this.value)"
                                       style="padding: 6px; border-radius: 4px; border: 1px solid #ddd; width: 300px;">
                            </div>
                        </div>
                        <div class="table-wrapper">
                            ${this.createUrlPatternLinksTable(tableId, links)}
                        </div>
                    </div>
                `;
            }

            createUrlPatternLinksTable(tableId, links) {
                if (!links || links.length === 0) {
                    return '<div style="padding: 1rem; text-align: center; color: #666;">No links found</div>';
                }

                const destination = this.extractDestinationFromUrl(this.auditUrl);

                let headers = ['Available/Valid', 'Text', 'URL'];
                const hasAvailability = links.some(link => link.available !== undefined);
                const hasValidation = links.some(link => link.valid !== undefined);
                const hasPrice = links.some(link => link.price !== undefined);
                const hasShipOptions = links.some(link => link.shipOptions !== undefined);
                const hasExperienceOptions = links.some(link => link.experienceOptions !== undefined);
                const hasPageType = links.some(link => link.pageType !== undefined);
                const hasErrors = links.some(link => 
                    link.validationError || link.availabilityError || link.error);

                if (hasPrice) headers.push('Price');
                if (hasShipOptions) headers.push('Ships Found');
                if (hasPageType) headers.push('Page Type');
                if (hasExperienceOptions) headers.push('Activity/Experience Options');
                if (hasValidation) headers.push('HTTP Status', 'Redirected');
                if (hasErrors) headers.push('Error Details');

                const rows = links.map(link => {
                    let row = '<tr>';
                    
                    let statusBadge = '';
                    
                    if (link.available !== undefined) {
                        statusBadge = `<span class="status-badge ${link.available ? 'status-available' : 'status-unavailable'}">${link.available ? 'Available' : 'Unavailable'}</span>`;
                    } else if (link.valid !== undefined) {
                        statusBadge = `<span class="status-badge ${link.valid ? 'status-valid' : 'status-invalid'}">${link.valid ? 'Valid' : 'Invalid'}</span>`;
                    } else {
                        statusBadge = '<span class="status-badge status-unknown">Unknown</span>';
                    }
                    
                    row += `<td>${statusBadge}</td>`;
                    row += `<td>${this.escapeHtml(link.text)}</td>`;
                    row += `<td><a href="${link.href}" target="_blank" class="url-link">${link.href}</a></td>`;
                    
                    if (hasPrice) {
                        row += `<td>${link.price ? `${link.price} ${link.currency || ''}` : '-'}</td>`;
                    }
                    if (hasShipOptions) {
                        row += `<td>${link.shipOptions ? `${link.shipOptions.length} ships` : '-'}</td>`;
                    }
                    if (hasPageType) {
                        const pageTypeStyle = link.pageType === 'landing' ? 'background: #e8f5e9; color: #2e7d32;' : 
                                             link.pageType === 'index' ? 'background: #e3f2fd; color: #1976d2;' : '';
                        row += `<td><span class="category-badge" style="${pageTypeStyle}">${link.pageType || 'Unknown'}</span></td>`;
                    }
                    if (hasExperienceOptions) {
                        let optionsText = '';
                        if (link.experienceOptions && link.experienceOptions.length > 0) {
                            optionsText = `${link.experienceOptions.length} experiences`;
                        } else if (link.activityPath) {
                            optionsText = `Activity: ${link.activityPath}`;
                        } else {
                            optionsText = '0 options';
                        }
                        row += `<td>${optionsText}</td>`;
                    }
                    if (hasValidation) {
                        row += `<td>${link.status || '-'}</td>`;
                        row += `<td><span class="status-badge ${link.redirected ? 'status-unavailable' : 'status-available'}">${link.redirected ? 'Yes' : 'No'}</span></td>`;
                    }
                    if (hasErrors) {
                        const allErrors = [];
                        if (link.validationError) {
                            allErrors.push(this.convertToUserFriendlyError(link.validationError, link.category, destination, link.text));
                        }
                        if (link.availabilityError) {
                            allErrors.push(this.convertToUserFriendlyError(link.availabilityError, link.category, destination, link.text));
                        }
                        if (link.error) {
                            allErrors.push(this.convertToUserFriendlyError(link.error, link.category, destination, link.text));
                        }
                        row += `<td>${allErrors.length > 0 ? allErrors.join('<br>') : '-'}</td>`;
                    }
                    
                    row += '</tr>';
                    return row;
                }).join('');

                return `
                    <table id="${tableId}">
                        <thead>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                `;
            }

            sanitizeId(str) {
                return str.replace(/[^a-zA-Z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
            }

            renderSectionBasedTables(container) {
                const sectionBreakdown = this.data.detailedResults.sectionBreakdown;
                
                if (sectionBreakdown.length > 1) {
                    const sectionNav = `
                        <div class="table-container" style="margin-bottom: 1rem;">
                            <div class="table-header">
                                <h3>üìã Navigate to Section</h3>
                            </div>
                            <div style="padding: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${sectionBreakdown.map(section => `
                                    <button class="btn btn-secondary" onclick="document.getElementById('section-${section.section}').scrollIntoView({behavior: 'smooth'})">
                                        ${section.section} (${section.totalLinks})
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', sectionNav);
                }

                sectionBreakdown.forEach(section => {
                    if (section.titleGroups && section.titleGroups.length > 0) {
                        const sectionHtml = this.createSectionTable(section);
                        container.insertAdjacentHTML('beforeend', sectionHtml);
                    }
                });
            }

            createSectionTable(section) {
                const sectionId = `section-${section.section}`;
                const destination = this.extractDestinationFromUrl(this.auditUrl);
                
                const titleCounts = {};
                section.titleGroups.forEach(titleGroup => {
                    const title = titleGroup.title;
                    titleCounts[title] = (titleCounts[title] || 0) + 1;
                });
                
                const duplicateTitles = Object.keys(titleCounts).filter(title => titleCounts[title] > 1);
                const hasDuplicates = duplicateTitles.length > 0;
                
                let sectionHeaderHtml = `
                    <div class="table-container" id="${sectionId}" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3>üìç ${section.section} Section (${section.totalLinks} links)</h3>
                            ${hasDuplicates ? `
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                                    <small style="color: #856404;">
                                        ‚ö†Ô∏è <strong>Content variety issue:</strong> ${duplicateTitles.map(title => `"${title}" (${titleCounts[title]}x)`).join(', ')}
                                    </small>
                                </div>
                            ` : ''}
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
                                ${Object.keys(section.categories).map(cat => `
                                    <span class="category-badge" style="background: #e3f2fd; color: #1976d2; padding: 4px 8px;">
                                        ${cat}: ${section.categories[cat]}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        <div style="padding: 0;">
                `;

                section.titleGroups.forEach((titleGroup, index) => {
                    const titleTableId = `table-${section.section}-${index}`;
                    const isDuplicate = titleCounts[titleGroup.title] > 1;
                    
                    sectionHeaderHtml += `
                        <div style="border-top: 1px solid #ddd; ${index === 0 ? 'border-top: none;' : ''}">
                            <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; ${isDuplicate ? 'border-left: 4px solid #ffc107;' : ''}">
                                <h4 style="margin: 0; color: #495057; ${isDuplicate ? 'display: flex; align-items: center; gap: 0.5rem;' : ''}">
                                    ${isDuplicate ? '<span style="color: #f57c00; font-size: 16px;">‚ö†Ô∏è</span>' : ''}
                                    ${titleGroup.title} (${titleGroup.linkCount} links)
                                    ${isDuplicate ? `<span style="background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: normal;">DUPLICATE ${titleCounts[titleGroup.title]}x</span>` : ''}
                                </h4>
                                <div style="margin-top: 0.5rem;">
                                    <input type="text" placeholder="Search in this section..." 
                                           onkeyup="filterTable('${titleTableId}', this.value)"
                                           style="padding: 6px; border-radius: 4px; border: 1px solid #ddd; width: 300px;">
                                </div>
                            </div>
                            <div class="table-wrapper">
                                ${this.createLinksTable(titleTableId, titleGroup.links, destination)}
                            </div>
                        </div>
                    `;
                });

                sectionHeaderHtml += `
                        </div>
                    </div>
                `;

                return sectionHeaderHtml;
            }

            createLinksTable(tableId, links, destination) {
                if (!links || links.length === 0) {
                    return '<div style="padding: 1rem; text-align: center; color: #666;">No links found</div>';
                }

                let headers = ['Available/Valid', 'Reason', 'Text', 'URL', 'Category'];
                const hasAvailability = links.some(link => link.available !== undefined);
                const hasValidation = links.some(link => link.valid !== undefined);
                const hasPrice = links.some(link => link.price !== undefined);
                const hasShipOptions = links.some(link => link.shipOptions !== undefined);
                const hasExperienceOptions = links.some(link => link.experienceOptions !== undefined);
                const hasErrors = links.some(link => 
                    link.validationError || link.availabilityError || link.error);

                if (hasPrice) headers.push('Price');
                if (hasShipOptions) headers.push('Ships Found');
                if (hasExperienceOptions) headers.push('Experience Options');
                if (hasValidation) headers.push('HTTP Status', 'Redirected');
                if (hasErrors) headers.push('Additional Errors');

                const rows = links.map(link => {
                    let row = '<tr>';
                    
                    let statusBadge = '';
                    const reasonText = this.getUserFriendlyReason(link, destination);
                    
                    if (link.available !== undefined) {
                        statusBadge = `<span class="status-badge ${link.available ? 'status-available' : 'status-unavailable'}">${link.available ? 'Available' : 'Unavailable'}</span>`;
                    } else if (link.valid !== undefined) {
                        statusBadge = `<span class="status-badge ${link.valid ? 'status-valid' : 'status-invalid'}">${link.valid ? 'Valid' : 'Invalid'}</span>`;
                    } else {
                        statusBadge = '<span class="status-badge status-unknown">Unknown</span>';
                    }
                    
                    row += `<td>${statusBadge}</td>`;
                    row += `<td style="font-size: 12px; color: #666;">${reasonText}</td>`;
                    row += `<td>${this.escapeHtml(link.text)}</td>`;
                    row += `<td><a href="${link.href}" target="_blank" class="url-link">${link.href}</a></td>`;
                    row += `<td><span class="category-badge">${link.category || 'Unknown'}</span></td>`;
                    
                    if (hasPrice) {
                        row += `<td>${link.price ? `${link.price} ${link.currency || ''}` : '-'}</td>`;
                    }
                    if (hasShipOptions) {
                        row += `<td>${link.shipOptions ? `${link.shipOptions.length} ships` : '-'}</td>`;
                    }
                    if (hasExperienceOptions) {
                        row += `<td>${link.experienceOptions ? `${link.experienceOptions.length} options` : '-'}</td>`;
                    }
                    if (hasValidation) {
                        row += `<td>${link.status || '-'}</td>`;
                        row += `<td><span class="status-badge ${link.redirected ? 'status-unavailable' : 'status-available'}">${link.redirected ? 'Yes' : 'No'}</span></td>`;
                    }
                    if (hasErrors) {
                        const additionalErrors = [];
                        if (link.validationError && !reasonText.includes(link.validationError)) {
                            additionalErrors.push(this.convertToUserFriendlyError(link.validationError, link.category, destination, link.text));
                        }
                        if (link.availabilityError && !reasonText.includes(link.availabilityError)) {
                            additionalErrors.push(this.convertToUserFriendlyError(link.availabilityError, link.category, destination, link.text));
                        }
                        if (link.error && !reasonText.includes(link.error)) {
                            additionalErrors.push(this.convertToUserFriendlyError(link.error, link.category, destination, link.text));
                        }
                        row += `<td>${additionalErrors.length > 0 ? additionalErrors.join('<br>') : '-'}</td>`;
                    }
                    
                    row += '</tr>';
                    return row;
                }).join('');

                return `
                    <table id="${tableId}">
                        <thead>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                `;
            }

            exportJson() {
                if (!this.data) return;
                
                const dataStr = JSON.stringify(this.data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `link-audit-${new Date().getTime()}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
            }

            exportCsv() {
                if (!this.data) return;
                
                const destination = this.extractDestinationFromUrl(this.auditUrl);
                let csv = 'Category,Text,URL,Status,Reason,Additional Info\n';
                
                Object.keys(this.data.linksByCategory).forEach(category => {
                    this.data.linksByCategory[category].forEach(link => {
                        const text = `"${link.text.replace(/"/g, '""')}"`;
                        const url = `"${link.href}"`;
                        const status = link.available !== undefined ? (link.available ? 'Available' : 'Unavailable') : 
                                     link.valid !== undefined ? (link.valid ? 'Valid' : 'Invalid') : 'Unknown';
                        const reason = `"${this.getUserFriendlyReason(link, destination).replace(/"/g, '""')}"`;
                        const additionalInfo = link.price ? `Price: ${link.price}` : 
                                             link.error ? this.convertToUserFriendlyError(link.error, category, destination, link.text) : '';
                        
                        csv += `${category},${text},${url},${status},${reason},"${additionalInfo}"\n`;
                    });
                });
                
                const dataBlob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `link-audit-${new Date().getTime()}.csv`;
                link.click();
                
                URL.revokeObjectURL(url);
            }

            printReport() {
                window.print();
            }

            destroyCharts() {
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                this.charts = {};
            }

            showLoading(show) {
                document.getElementById('loadingState').classList.toggle('hidden', !show);
                document.getElementById('analyzeBtn').disabled = show;
            }

            showError(message) {
                const errorState = document.getElementById('errorState');
                errorState.textContent = message;
                errorState.classList.remove('hidden');
            }

            showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.textContent = message;
                document.querySelector('.container').insertBefore(successDiv, document.getElementById('loadingState'));
                
                setTimeout(() => successDiv.remove(), 5000);
            }

            clearError() {
                document.getElementById('errorState').classList.add('hidden');
            }

            clearResults() {
                this.data = null;
                this.auditUrl = '';
                this.destroyCharts();
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('insightsPanel').style.display = 'none';
                this.clearError();
                
                this.switchTab('summary');
                
                document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('[data-subtab="section"]').classList.add('active');
                document.querySelectorAll('.sub-tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById('sectionView').classList.remove('hidden');
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Global function for table filtering
        function filterTable(tableId, searchTerm) {
            const table = document.getElementById(tableId);
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                const isVisible = text.includes(searchTerm.toLowerCase());
                row.style.display = isVisible ? '' : 'none';
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new LinkAuditDashboard();
        });
    </script>
</body>
</html>